@using GitNinja.Gallery.Web
@using GitNinja.Gallery.Web.App_Start
@using PagedList
@using PagedList.Mvc
@model global::GitNinja.Gallery.Web.Models.Repo
@{
    ViewBag.Title = Model.Name;
    const int pageSize = 10;
    var pageNumber = int.Parse(Request["page"] ?? "1");
    var commits = Model.Repository.Commits.ToPagedList(pageNumber, pageSize);
}
@section topbar
{
    <h4>
        @Html.ActionLink("Dashboard", "Index", "Dojo")<span class="divider"> /</span>
        @Html.ActionLink(Model.Dojo, "Dojo", new { dojo = Model.Dojo })<span class="divider"> /</span>
        @Html.ActionLink(Model.Name, "Repo", new { dojo = Model.Dojo, repo = Model.Name })
    </h4>
}
@section head{
    @Styles.Render("~/Content/paging")
}
@section bottom {
    <script type="text/javascript">
        $(function() {
            $('#repo-tab a:first').tab('show');

            $.get('@Url.RouteUrl("tree", new {dojo = Model.Dojo, repo = Model.Name, branch = "master"})', function(data) {
                $('#tree-container').html(data);
                hookupTreeEvents();
            });

            var hookupTreeEvents = function() {
                $('#tree-container a').click(function() {
                    if (Modernizr.history) {
                        history.pushState({ path: this.path }, '', this.href);
                    }
                    $('#tree-container').addClass('is-loading');
                    $.get(this.href, function (data) {
                        $('#tree-container').html(data);
                        $('#tree-container').removeClass('is-loading');
                        hookupTreeEvents();
                    });

                    return false;
                });
            };
        });
    </script>    
}

<div class="row">
    <div class="span12">
        <div class="input-prepend">
            <button type="button" class="btn" disabled="disabled">HTTP</button>
            <button type="button" class="btn" disabled="disabled">SSH</button>
            @Html.TextBox("GitRepositoryUrl", Model.Url, new { @class = "input-xxlarge input-url"})
        </div>


        <ul class="nav nav-tabs" id="repo-tab">
            <li><a href="#commits" data-toggle="tab">Commits</a></li>
            <li><a href="#files" data-toggle="tab">Files</a></li>
            <li><a href="#pull-requests" data-toggle="tab">Pull Requests</a></li>
            <li><a href="#settings" data-toggle="tab">Settings</a></li>
        </ul>    
        <div class="tab-content">
            <div class="tab-pane active" id="commits">
                <ul class="nav nav-stacked">
                    @foreach (var commit in commits) {
                        <li class="well well-small" style="margin-bottom: 3px; font-size: smaller;">
                            @Html.Raw(Html.Gravatar(commit.Author.Email, 40, htmlAttributes: new { @class = "gravatar pull-left img-rounded", style = "margin-right: 10px;" }))
                            <div class="commit-details pull-left">
                                @Html.ActionLink(commit.MessageShort, "Detail", "Commit", new { id = commit.Id }, new { @class = "commit-message", style = "" })<br />
                                @Html.ActionLink(commit.Author.Name, "Detail", "Author", new { id = commit.Author.Email.ToMd5Hash() }, new { @class = "commit-author" })
                            </div>
                            <div class="commit-links pull-right">
                                @Html.ActionLink(commit.Id.ToString(12), "Detail", "Commit", new { id = commit.Id }, new { @class = "label pull-right" })<br />
                                @Html.ActionLink("Browse code", "Detail", "Commit", new { id = commit.Id }, new { @class = "label label-info pull-right" })
                            </div>
                            <div class="clearfix"></div>
                        </li>
                    }
                </ul>
                @Html.PagedListPager(commits, page => Url.Action("Repo", "Dojo", new { page }))                
            </div>
            <div class="tab-pane" id="files">
                <div id="tree-container"></div>
            </div>
            <div class="tab-pane" id="pull-requests">...</div>
            <div class="tab-pane" id="settings">...</div>
        </div>
    </div>
</div>